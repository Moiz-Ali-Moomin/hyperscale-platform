---
# Common role - Base system configuration

- name: Update system packages
  apt:
    update_cache: yes
    upgrade: dist
    cache_valid_time: 3600
  become: yes

- name: Install essential packages
  apt:
    name:
      - curl
      - wget
      - git
      - vim
      - htop
      - net-tools
      - python3
      - python3-pip
      - jq
    state: present
  become: yes

- name: Configure system timezone
  timezone:
    name: "{{ timezone | default('UTC') }}"
  become: yes

- name: Set system hostname
  hostname:
    name: "{{ inventory_hostname }}"
  become: yes

- name: Configure sysctl for performance
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { key: "net.core.somaxconn", value: "65535" }
    - { key: "net.ipv4.tcp_max_syn_backlog", value: "8192" }
    - { key: "net.ipv4.ip_local_port_range", value: "1024 65535" }
    - { key: "fs.file-max", value: "2097152" }
  become: yes

- name: Set file descriptor limits
  pam_limits:
    domain: "*"
    limit_type: "{{ item.type }}"
    limit_item: nofile
    value: "{{ item.value }}"
  loop:
    - { type: "soft", value: "65536" }
    - { type: "hard", value: "65536" }
  become: yes

- name: Create application user
  user:
    name: appuser
    state: present
    shell: /bin/bash
    create_home: yes
  become: yes

- name: Disable firewall (managed by security groups)
  systemd:
    name: ufw
    state: stopped
    enabled: no
  become: yes
  ignore_errors: yes
